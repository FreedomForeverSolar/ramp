name: Release UI

on:
  push:
    tags:
      - 'ui-v*'

permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#ui-v}" >> $GITHUB_OUTPUT

      - name: Build Go backend (arm64)
        run: |
          GOOS=darwin GOARCH=arm64 go build -o ramp-ui/frontend/resources/ramp-server-arm64 ./cmd/ramp-ui

      - name: Build Go backend (x64)
        run: |
          GOOS=darwin GOARCH=amd64 go build -o ramp-ui/frontend/resources/ramp-server-x64 ./cmd/ramp-ui

      - name: Create universal binary
        run: |
          lipo -create -output ramp-ui/frontend/resources/ramp-server \
            ramp-ui/frontend/resources/ramp-server-arm64 \
            ramp-ui/frontend/resources/ramp-server-x64
          rm ramp-ui/frontend/resources/ramp-server-arm64 ramp-ui/frontend/resources/ramp-server-x64

      - name: Install frontend dependencies
        working-directory: ramp-ui/frontend
        run: bun install

      - name: Set version in package.json
        working-directory: ramp-ui/frontend
        run: bun run set-version
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}

      - name: Import code signing certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Decode certificate
          echo -n "$APPLE_CERTIFICATE" | base64 --decode -o $CERTIFICATE_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          security import $CERTIFICATE_PATH -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Verify
          security find-identity -v -p codesigning $KEYCHAIN_PATH

      - name: Build and package
        working-directory: ramp-ui/frontend
        run: bun run package:publish
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            ramp-ui/frontend/release/*.dmg
            ramp-ui/frontend/release/*.zip
            ramp-ui/frontend/release/*.yml
          if-no-files-found: error

  # build-linux:
  #   name: Build Linux
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Set up Go
  #       uses: actions/setup-go@v5
  #       with:
  #         go-version: '1.24'

  #     - name: Setup Bun
  #       uses: oven-sh/setup-bun@v2
  #       with:
  #         bun-version: latest

  #     - name: Extract version from tag
  #       id: version
  #       run: echo "VERSION=${GITHUB_REF_NAME#ui-v}" >> $GITHUB_OUTPUT

  #     - name: Build Go backend
  #       run: |
  #         GOOS=linux GOARCH=amd64 go build -o ramp-ui/frontend/resources/ramp-server ./cmd/ramp-ui

  #     - name: Install frontend dependencies
  #       working-directory: ramp-ui/frontend
  #       run: bun install

  #     - name: Set version in package.json
  #       working-directory: ramp-ui/frontend
  #       run: bun run set-version
  #       env:
  #         VERSION: ${{ steps.version.outputs.VERSION }}

  #     - name: Build and package
  #       working-directory: ramp-ui/frontend
  #       run: bun run package:publish
  #       env:
  #         GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  #     - name: Upload artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: linux-build
  #         path: |
  #           ramp-ui/frontend/release/*.AppImage
  #           ramp-ui/frontend/release/*.yml
  #         if-no-files-found: error

  # build-windows:
  #   name: Build Windows
  #   runs-on: windows-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Set up Go
  #       uses: actions/setup-go@v5
  #       with:
  #         go-version: '1.24'

  #     - name: Setup Bun
  #       uses: oven-sh/setup-bun@v2
  #       with:
  #         bun-version: latest

  #     - name: Extract version from tag
  #       id: version
  #       shell: bash
  #       run: echo "VERSION=${GITHUB_REF_NAME#ui-v}" >> $GITHUB_OUTPUT

  #     - name: Build Go backend
  #       run: |
  #         $env:GOOS = "windows"
  #         $env:GOARCH = "amd64"
  #         go build -o ramp-ui/frontend/resources/ramp-server.exe ./cmd/ramp-ui

  #     - name: Install frontend dependencies
  #       working-directory: ramp-ui/frontend
  #       run: bun install

  #     - name: Set version in package.json
  #       working-directory: ramp-ui/frontend
  #       run: bun run set-version
  #       env:
  #         VERSION: ${{ steps.version.outputs.VERSION }}

  #     - name: Build and package
  #       working-directory: ramp-ui/frontend
  #       run: bun run package:publish
  #       env:
  #         GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  #     - name: Upload artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: windows-build
  #         path: |
  #           ramp-ui/frontend/release/*.exe
  #           ramp-ui/frontend/release/*.yml
  #         if-no-files-found: error
